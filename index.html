<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lifetime File Link Generator â€” Upgraded</title>
<style>
  :root{
    --bg:#f4f6ff; --card:#fff; --brand:#3867d6; --muted:#6b7280;
    --success:#16a34a; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0b1220}
  .wrap{max-width:980px;margin:28px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  header h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 28px rgba(10,20,50,0.06)}
  .uploader{display:grid;grid-template-columns:1fr 340px;gap:16px}
  @media(max-width:880px){ .uploader{grid-template-columns:1fr} .side{order:2} }
  .drop{
    border:2px dashed rgba(56,103,214,0.18);
    background:linear-gradient(180deg, rgba(61,114,238,0.03), transparent);
    border-radius:10px;padding:18px;min-height:160px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
  }
  .drop.dragover{background:rgba(61,114,238,0.04);border-color:rgba(56,103,214,0.36)}
  .drop p{margin:0;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--brand);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;color:var(--brand);border:1px solid rgba(56,103,214,0.12)}
  input[type=file]{display:none}
  .filePreviewList{margin-top:14px;display:flex;flex-direction:column;gap:10px}
  .fileRow{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;border:1px solid #eef2ff;background:#fff}
  .thumb{width:92px;height:64px;border-radius:6px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img, .thumb video{max-width:100%;max-height:100%;display:block}
  .meta{flex:1}
  .meta b{display:block;margin-bottom:6px}
  .progress{height:8px;background:#f1f5f9;border-radius:6px;overflow:hidden;margin-top:6px}
  .bar{height:100%;background:var(--brand);width:0%}
  .side{display:flex;flex-direction:column;gap:12px}
  .history{margin-top:12px}
  .historyHeader{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .search{padding:8px;border-radius:8px;border:1px solid #e6edf8;width:100%}
  .list{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:700px){ .list{grid-template-columns:1fr} }
  .cardSmall{background:#fff;padding:10px;border-radius:8px;border:1px solid #eef2ff;display:flex;gap:8px;align-items:center}
  .link{font-family:monospace;font-size:12px;color:#0b1220;word-break:break-all}
  .tinyBtn{padding:6px 8px;border-radius:8px;border:0;background:#eef2ff;color:var(--brand);cursor:pointer;font-weight:600}
  .copyOk{background:var(--success);color:#fff}
  .deletedNote{color:var(--danger);font-size:13px}
  footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .pwBox{display:flex;gap:8px;align-items:center}
  .pwBox input{padding:8px;border-radius:8px;border:1px solid #eef2ff}
  .tag{display:inline-block;background:#eef2ff;color:var(--brand);padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
  .kbd{font-family:monospace;background:#f8fafc;padding:4px 6px;border-radius:6px;border:1px solid #eef2ff}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#3d72ee,#5aa0ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">L</div>
      <div>
        <h1>Lifetime File Link Generator â€” Upgraded</h1>
        <div class="small">No API key Â· Catbox.moe uploader Â· Multiple files Â· History Â· Password-protected delete (local)</div>
      </div>
    </header>

    <div class="card uploader">
      <div>
        <div id="dropArea" class="drop">
          <div style="text-align:center">
            <svg width="46" height="46" viewBox="0 0 24 24" fill="none" style="margin-bottom:8px"><path d="M12 3v9" stroke="#3d72ee" stroke-width="1.6" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="#3d72ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 21H4" stroke="#cfe0ff" stroke-width="1.6" stroke-linecap="round"/></svg>
            <p><strong>Drop files here</strong> or <span class="kbd">Browse</span></p>
            <p class="small">Images, audio, video, PDF â€” up to 200MB each (Catbox may allow larger)</p>
          </div>
          <input id="fileInput" type="file" multiple />
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center" class="controls">
          <label for="fileInput" class="btn ghost" style="padding:10px 14px;cursor:pointer">Choose Files</label>
          <button id="uploadAll" class="btn">Upload Selected</button>
          <button id="clearSelection" class="btn ghost">Clear Selection</button>
        </div>

        <div class="filePreviewList" id="filePreviewList"></div>
      </div>

      <aside class="side">
        <div class="cardSmall">
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Your Uploads</strong><div class="small">Local history (browser)</div></div>
              <div><span class="tag">Catbox</span></div>
            </div>
          </div>
        </div>

        <div class="cardSmall">
          <div style="width:100%">
            <div class="historyHeader">
              <input id="searchBox" class="search" placeholder="Search by filename or urlâ€¦" />
            </div>
            <div style="margin-top:8px" class="pwBox">
              <input id="password" type="password" placeholder="Set/Delete password for history (optional)" />
              <button id="setPw" class="tinyBtn">Set / Update</button>
            </div>
            <div class="small" style="margin-top:8px">Password protects delete action in this browser. It encrypts only the local history control. Files uploaded to Catbox remain on Catbox unless you use a storage provider with server-side delete.</div>
          </div>
        </div>

        <div id="historyList" class="list"></div>

        <div style="display:flex;gap:8px;align-items:center;justify-content:center">
          <button id="clearHistory" class="tinyBtn" style="background:#fff;color:var(--danger);border:1px solid #ffecec">Clear All Local History</button>
          <button id="exportHistory" class="tinyBtn">Export JSON</button>
        </div>
      </aside>
    </div>

    <footer class="small card" style="margin-top:12px">
      <strong>Note:</strong> This uploader uses <a href="https://catbox.moe" target="_blank">catbox.moe</a> (no API key). Deleting from <em>local history</em> removes it from your browser only. To support server-side permanent delete, I can provide a Firebase/S3 version â€” tell me if you want that.
    </footer>
  </div>

<script>
/*
 Upgraded Lifetime File Link Generator
 - Uploads to catbox.moe
 - Multiple files, drag-drop
 - Local history with password-protected deletion (password hashed with SHA-256)
 - Copy link / embed
 - Export JSON / Clear local history
*/

// ---- helpers ----
const $ = sel => document.querySelector(sel);
const create = (tag, attrs={}, ...children) => {
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => { if(k in e) e[k]=v; else e.setAttribute(k,v); });
  children.flat().forEach(c => { if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
  return e;
};

const STORAGE_KEY = 'lfu_history_v1';
const PW_KEY = 'lfu_pwhash_v1';

// SubtleCrypto SHA-256 -> hex
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Copy to clipboard with fallback
async function copyText(text){
  try { await navigator.clipboard.writeText(text); return true; }
  catch(e){
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    try { document.execCommand('copy'); ta.remove(); return true; } catch(e){ ta.remove(); return false; }
  }
}

// format bytes
function fmtBytes(n){
  if(n<1024) return n + ' B';
  if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
  if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB';
  return (n/1024/1024/1024).toFixed(2)+' GB';
}

// ---- state ----
let selection = []; // File objects selected (not uploaded yet)
let uploading = new Map(); // path -> controller
let history = loadHistory();

// ---- DOM ----
const dropArea = document.getElementById('dropArea');
const inputFile = document.getElementById('fileInput');
const filePreviewList = document.getElementById('filePreviewList');
const uploadAllBtn = document.getElementById('uploadAll');
const clearSelBtn = document.getElementById('clearSelection');
const historyListEl = document.getElementById('historyList');
const searchBox = document.getElementById('searchBox');
const passwordInput = document.getElementById('password');
const setPwBtn = document.getElementById('setPw');
const clearHistoryBtn = document.getElementById('clearHistory');
const exportHistoryBtn = document.getElementById('exportHistory');

// ---- drag & drop ----
['dragenter','dragover'].forEach(ev => {
  dropArea.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation();
    dropArea.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev => {
  dropArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('dragover'); });
});
dropArea.addEventListener('drop', e=>{
  const files = Array.from(e.dataTransfer.files || []);
  addSelection(files);
});

// file input change
inputFile.addEventListener('change', e=> addSelection(Array.from(e.target.files)));

// select files programmatically by clicking label (already wired)

// ---- selection UI ----
function addSelection(files){
  for(const f of files){
    // skip zero size
    if(f.size === 0) continue;
    selection.push(f);
  }
  renderSelection();
}
function clearSelection(){ selection = []; inputFile.value=''; renderSelection(); }
clearSelBtn.addEventListener('click', clearSelection);

// render selection list
function renderSelection(){
  filePreviewList.innerHTML = '';
  if(selection.length === 0){
    filePreviewList.innerHTML = `<div class="small" style="padding:8px;color:var(--muted)">No files selected. Drag & drop files here or click "Choose Files".</div>`;
    return;
  }
  for(const [i, file] of selection.entries()){
    const row = create('div',{className:'fileRow'});
    const thumb = create('div',{className:'thumb'});
    const meta = create('div',{className:'meta'});
    const controls = create('div',{style:'display:flex;gap:8px;align-items:center'});

    // preview
    if(file.type.startsWith('image/')){
      const img = document.createElement('img'); img.src = URL.createObjectURL(file);
      img.onload = ()=> URL.revokeObjectURL(img.src);
      thumb.appendChild(img);
    } else if(file.type.startsWith('video/')){
      const v = document.createElement('video'); v.src = URL.createObjectURL(file); v.muted=true; v.playsInline=true; v.style.maxWidth='100%';
      v.onloadeddata = ()=> URL.revokeObjectURL(v.src);
      thumb.appendChild(v);
    } else if(file.type.startsWith('audio/')){
      const a = document.createElement('div'); a.textContent='ðŸŽµ'; a.style.fontSize='20px'; thumb.appendChild(a);
    } else {
      const a = document.createElement('div'); a.textContent='ðŸ“„'; a.style.fontSize='20px'; thumb.appendChild(a);
    }

    meta.appendChild(create('b',{}, file.name));
    meta.appendChild(create('div',{}, `${fmtBytes(file.size)} Â· ${file.type || 'unknown'}`));
    const barWrap = create('div',{className:'progress'}); const bar = create('div',{className:'bar'}); barWrap.appendChild(bar);
    meta.appendChild(barWrap);

    const removeBtn = create('button',{className:'tinyBtn'}, 'Remove'); removeBtn.onclick = ()=>{
      selection.splice(i,1); renderSelection();
    };
    controls.appendChild(removeBtn);
    row.appendChild(thumb);
    row.appendChild(meta);
    row.appendChild(controls);
    filePreviewList.appendChild(row);

    // if uploading in progress, update bar etc via uploading Map
    // We'll assign bar element to file object for later updates:
    file._bar = bar;
  }
}

// ---- upload logic (Catbox) ----
async function uploadSingle(file, onProgress){
  // Catbox endpoint:
  const endpoint = 'https://catbox.moe/user/api.php';
  const form = new FormData();
  form.append('reqtype','fileupload');
  form.append('fileToUpload', file, file.name);

  // Use fetch with progress via XHR (to report upload progress)
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', endpoint);
    xhr.onload = ()=> {
      if(xhr.status >= 200 && xhr.status < 300){
        resolve(xhr.responseText.trim());
      } else reject(new Error('Upload failed: ' + xhr.status));
    };
    xhr.onerror = ()=> reject(new Error('Network error'));
    xhr.upload.onprogress = (e) => {
      if(e.lengthComputable && onProgress) onProgress(Math.round((e.loaded/e.total)*100));
    };
    xhr.send(form);
  });
}

// Upload all selected files
uploadAllBtn.addEventListener('click', async () => {
  if(selection.length === 0) return alert('No files selected.');
  // copy selection array to avoid mutation during upload
  const toUpload = Array.from(selection);
  uploadAllBtn.disabled = true; uploadAllBtn.textContent = 'Uploadingâ€¦';
  for(const file of toUpload){
    // find file bar in UI
    const bar = file._bar;
    try {
      bar.style.width = '0%';
      addToast(`Uploading ${file.name}...`);
      const url = await uploadSingle(file, pct => { bar.style.width = pct + '%'; });
      addToast(`Uploaded ${file.name}`);
      // push to history
      const entry = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,8),
        name: file.name,
        size: file.size,
        type: file.type,
        url: url,
        uploadedAt: (new Date()).toISOString()
      };
      history.unshift(entry); saveHistory(); renderHistory(searchBox.value);
    } catch(err){
      console.error(err);
      addToast(`Upload failed: ${file.name}`, true);
      alert('Upload failed for ' + file.name + ': ' + (err.message || err));
    }
  }
  // after upload, clear selection
  selection = [];
  renderSelection();
  uploadAllBtn.disabled = false; uploadAllBtn.textContent = 'Upload Selected';
});

// ---- history (localStorage) ----
function loadHistory(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch(e){ return []; }
}
function saveHistory(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
}

// render history cards
function renderHistory(filter=''){
  historyListEl.innerHTML = '';
  const q = (filter||'').toLowerCase().trim();
  const filtered = history.filter(h => !q || (h.name && h.name.toLowerCase().includes(q)) || (h.url && h.url.toLowerCase().includes(q)));
  if(filtered.length === 0){
    historyListEl.innerHTML = `<div class="small" style="grid-column:1/-1;padding:6px;color:var(--muted)">No uploads yet.</div>`;
    return;
  }
  for(const entry of filtered){
    const elCard = create('div',{className:'cardSmall'});
    const thumb = create('div',{className:'thumb'});
    // preview based on extension
    const lower = (entry.name || '').toLowerCase();
    if(lower.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/)){
      const img = new Image(); img.src = entry.url; img.alt = entry.name; thumb.appendChild(img);
    } else if(lower.match(/\.(mp4|webm|ogg|mov)$/)){
      const v = document.createElement('video'); v.src = entry.url; v.controls=true; v.style.maxWidth='120px'; thumb.appendChild(v);
    } else if(lower.match(/\.(mp3|wav|ogg)$/)){
      const a = document.createElement('audio'); a.src = entry.url; a.controls=true; thumb.appendChild(a);
    } else {
      thumb.textContent = 'ðŸ“„';
      thumb.style.fontSize = '20px';
      thumb.style.display = 'flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center';
    }

    const meta = create('div',{style:'flex:1'});
    const nameB = create('b',{}, entry.name);
    const info = create('div',{className:'small'}, `${fmtBytes(entry.size || 0)} Â· ${new Date(entry.uploadedAt).toLocaleString()}`);
    const urlDiv = create('div',{className:'link'}, entry.url);

    // buttons: copy link, embed, delete (pw-check)
    const btnRow = create('div',{style:'display:flex;gap:8px;margin-top:8px'});
    const copyBtn = create('button',{className:'tinyBtn'}, 'Copy Link');
    copyBtn.onclick = async ()=>{
      const ok = await copyText(entry.url);
      copyBtn.textContent = ok ? 'Copied!' : 'Copy';
      copyBtn.classList.toggle('copyOk', ok);
      setTimeout(()=>{ copyBtn.textContent = 'Copy Link'; copyBtn.classList.remove('copyOk') }, 1400);
    };

    const embedBtn = create('button',{className:'tinyBtn'}, 'Embed Tag');
    embedBtn.onclick = () => {
      let tag = `<a href="${entry.url}" target="_blank">Open file</a>`;
      if(lower.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/)) tag = `<img src="${entry.url}" alt="${escapeHtml(entry.name)}">`;
      else if(lower.match(/\.(mp4|webm|ogg|mov)$/)) tag = `<video controls src="${entry.url}"></video>`;
      else if(lower.match(/\.(mp3|wav|ogg)$/)) tag = `<audio controls src="${entry.url}"></audio>`;
      // show prompt for copy (safer UX)
      navigator.clipboard?.writeText(tag).then(()=> {
        addToast('Embed HTML copied to clipboard');
      }).catch(()=> {
        prompt('Copy this embed HTML:', tag);
      });
    };

    const delBtn = create('button',{className:'tinyBtn'}, 'Delete (local)');
    delBtn.onclick = async ()=>{
      // require password if set
      const stored = localStorage.getItem(PW_KEY);
      if(stored){
        const provided = prompt('Enter password to delete this entry (protects local history):');
        if(!provided) return;
        const h = await sha256Hex(provided);
        if(h !== stored){
          alert('Wrong password.');
          return;
        }
      } else {
        // if no password set, ask confirm
        if(!confirm('Delete this entry from local history? (This will NOT delete file from Catbox)')) return;
      }
      // remove from history array
      history = history.filter(h => h.id !== entry.id);
      saveHistory();
      renderHistory(searchBox.value);
      addToast('Removed from local history');
    };

    const openBtn = create('button',{className:'tinyBtn'}, 'Open');
    openBtn.onclick = ()=> window.open(entry.url, '_blank');

    btnRow.appendChild(copyBtn);
    btnRow.appendChild(embedBtn);
    btnRow.appendChild(openBtn);
    btnRow.appendChild(delBtn);

    meta.appendChild(nameB); meta.appendChild(info); meta.appendChild(urlDiv); meta.appendChild(btnRow);
    elCard.appendChild(thumb); elCard.appendChild(meta);
    historyListEl.appendChild(elCard);
  }
}

// ---- password set/update ----
setPwBtn.addEventListener('click', async ()=>{
  const val = passwordInput.value || '';
  if(!val){
    if(confirm('Remove existing password protection? (This will allow deletion without password)')){
      localStorage.removeItem(PW_KEY);
      addToast('Password removed');
    }
    passwordInput.value = '';
    return;
  }
  const h = await sha256Hex(val);
  localStorage.setItem(PW_KEY, h);
  passwordInput.value = '';
  addToast('Password set (protects local deletion)');
});

// ---- clear / export history ----
clearHistoryBtn.addEventListener('click', async ()=>{
  const stored = localStorage.getItem(PW_KEY);
  if(stored){
    const provided = prompt('Enter password to clear all local history:');
    if(!provided) return;
    const h = await sha256Hex(provided);
    if(h !== stored){ alert('Wrong password.'); return; }
  } else {
    if(!confirm('Clear all local history?')) return;
  }
  history = []; saveHistory(); renderHistory();
  addToast('Local history cleared');
});

exportHistoryBtn.addEventListener('click', ()=>{
  if(history.length === 0) return alert('No history to export.');
  const data = JSON.stringify(history, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'lfu_history.json'; a.click(); URL.revokeObjectURL(url);
});

// ---- search filter ----
searchBox.addEventListener('input', ()=> renderHistory(searchBox.value));

// ---- storage helpers ----
function saveHistory(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

// ---- small toasts ----
let toasts = [];
function addToast(msg, isErr=false){
  // tiny browser toast using alert fallback
  try {
    const t = document.createElement('div');
    t.textContent = msg; t.style.position='fixed'; t.style.right='20px'; t.style.bottom=(20 + toasts.length*54)+'px';
    t.style.background = isErr ? 'rgba(239,68,68,0.96)' : 'rgba(14,165,233,0.96)';
    t.style.color='#fff'; t.style.padding='10px 12px'; t.style.borderRadius='8px'; t.style.boxShadow='0 6px 20px rgba(2,6,23,0.2)';
    t.style.zIndex=9999; document.body.appendChild(t);
    toasts.push(t);
    setTimeout(()=>{ t.remove(); toasts.shift(); }, 2200);
  } catch(e){ console.log(msg); }
}

// initial render
renderSelection();
renderHistory();
</script>
</body>
</html>
